export interface LanguageDetectionResult {
  detectedLanguage: string;
  confidence: number;
  indicators: string[];
  suggestedLanguage: string;
}

export interface LanguageContext {
  restaurantName: string;
  restaurantAddress?: string;
  menuItems: Array<{
    name: string;
    description?: string;
    category?: string;
  }>;
  categories: string[];
}

// Language detection patterns and keywords
const LANGUAGE_PATTERNS = {
  romanian: {
    keywords: [
      // Common Romanian food terms
      'mÃ¢ncare', 'bÄƒuturÄƒ', 'desert', 'aperitiv', 'principal', 'supÄƒ', 'salatÄƒ',
      'carne', 'peÈ™te', 'pui', 'porc', 'vitÄƒ', 'miel', 'curcan', 'gÄƒinÄƒ',
      'cartofi', 'orez', 'pÃ¢ine', 'brÃ¢nzÄƒ', 'lapte', 'ouÄƒ', 'legume', 'fructe',
      'vin', 'bere', 'cafea', 'ceai', 'suc', 'apÄƒ', 'limonadÄƒ', 'compot',
      'plÄƒcintÄƒ', 'cozonac', 'pascÄƒ', 'colivÄƒ', 'sarmale', 'mÄƒmÄƒligÄƒ', 'ciorbÄƒ',
      'borÈ™', 'zeamÄƒ', 'tocanÄƒ', 'chiftea', 'mititei', 'covrigi', 'gogoaÈ™Äƒ',
      
      // Romanian restaurant terms
      'restaurant', 'bucÄƒtÄƒrie', 'meniu', 'preÈ›', 'gramaj', 'porÈ›ie',
      'chef', 'bucÄƒtar', 'ospÄƒtar', 'recepÈ›ie', 'rezervare', 'masÄƒ',
      
      // Romanian adjectives and descriptions
      'delicios', 'gustos', 'proaspÄƒt', 'cald', 'rece', 'picant', 'dulce',
      'sÄƒrat', 'acru', 'amÄƒrui', 'aromat', 'tradiÈ›ional', 'casnic', 'natural',
      'organic', 'vegetarian', 'vegan', 'fÄƒrÄƒ gluten', 'dietetic',
      
      // Romanian cooking methods
      'fript', 'copt', 'fiert', 'prÄƒjit', 'gÄƒtit', 'marinat', 'afumat',
      'grill', 'la cuptor', 'la grÄƒtar', 'Ã®n sos', 'cu sos', 'fÄƒrÄƒ sos'
    ],
    patterns: [
      /Äƒ|Ã¢|Ã®|È™|È›/g, // Romanian diacritics
      /(?:la|cu|din|pe|Ã®n|de|È™i|sau|sau|dar|sÄƒ|nu|este|sunt|am|ai|au)/g, // Common Romanian words
      /(?:mÃ¢ncare|bÄƒuturÄƒ|desert|aperitiv|principal)/g, // Romanian food categories
    ],
    confidence: 0.8
  },
  english: {
    keywords: [
      // Common English food terms
      'food', 'drink', 'beverage', 'dessert', 'appetizer', 'main', 'soup', 'salad',
      'meat', 'fish', 'chicken', 'pork', 'beef', 'lamb', 'turkey', 'duck',
      'potato', 'rice', 'bread', 'cheese', 'milk', 'egg', 'vegetable', 'fruit',
      'wine', 'beer', 'coffee', 'tea', 'juice', 'water', 'lemonade', 'soda',
      'cake', 'pie', 'cookie', 'ice cream', 'pudding', 'custard', 'tart',
      
      // English restaurant terms
      'restaurant', 'kitchen', 'menu', 'price', 'portion', 'serving',
      'chef', 'cook', 'waiter', 'server', 'reception', 'reservation', 'table',
      
      // English adjectives and descriptions
      'delicious', 'tasty', 'fresh', 'hot', 'cold', 'spicy', 'sweet',
      'salty', 'sour', 'bitter', 'aromatic', 'traditional', 'homemade', 'natural',
      'organic', 'vegetarian', 'vegan', 'gluten-free', 'dietary',
      
      // English cooking methods
      'fried', 'baked', 'boiled', 'grilled', 'cooked', 'marinated', 'smoked',
      'roasted', 'steamed', 'stewed', 'braised', 'sautÃ©ed', 'pan-fried'
    ],
    patterns: [
      /(?:the|and|or|but|with|in|on|at|to|for|of|a|an|is|are|was|were)/g, // Common English words
      /(?:food|drink|beverage|dessert|appetizer|main)/g, // English food categories
    ],
    confidence: 0.7
  },
  spanish: {
    keywords: [
      // Common Spanish food terms
      'comida', 'bebida', 'postre', 'aperitivo', 'plato', 'sopa', 'ensalada',
      'carne', 'pescado', 'pollo', 'cerdo', 'ternera', 'cordero', 'pavo',
      'patata', 'arroz', 'pan', 'queso', 'leche', 'huevo', 'verdura', 'fruta',
      'vino', 'cerveza', 'cafÃ©', 'tÃ©', 'zumo', 'agua', 'limonada', 'refresco',
      'pastel', 'tarta', 'galleta', 'helado', 'pudÃ­n', 'flan', 'tarta',
      
      // Spanish restaurant terms
      'restaurante', 'cocina', 'menÃº', 'precio', 'raciÃ³n', 'porciÃ³n',
      'chef', 'cocinero', 'camarero', 'recepcionista', 'reserva', 'mesa',
      
      // Spanish adjectives and descriptions
      'delicioso', 'sabroso', 'fresco', 'caliente', 'frÃ­o', 'picante', 'dulce',
      'salado', 'Ã¡cido', 'amargo', 'aromÃ¡tico', 'tradicional', 'casero', 'natural',
      'orgÃ¡nico', 'vegetariano', 'vegano', 'sin gluten', 'dietÃ©tico',
      
      // Spanish cooking methods
      'frito', 'asado', 'hervido', 'a la parrilla', 'cocido', 'marinado', 'ahumado',
      'al horno', 'al vapor', 'estofado', 'braseado', 'salteado', 'a la plancha'
    ],
    patterns: [
      /(?:el|la|los|las|y|o|pero|con|en|de|a|por|para|es|son|era|eran)/g, // Common Spanish words
      /(?:comida|bebida|postre|aperitivo|plato)/g, // Spanish food categories
    ],
    confidence: 0.7
  },
  french: {
    keywords: [
      // Common French food terms
      'nourriture', 'boisson', 'dessert', 'apÃ©ritif', 'plat', 'soupe', 'salade',
      'viande', 'poisson', 'poulet', 'porc', 'bÅ“uf', 'agneau', 'dinde',
      'pomme de terre', 'riz', 'pain', 'fromage', 'lait', 'Å“uf', 'lÃ©gume', 'fruit',
      'vin', 'biÃ¨re', 'cafÃ©', 'thÃ©', 'jus', 'eau', 'limonade', 'soda',
      'gÃ¢teau', 'tarte', 'biscuit', 'glace', 'pudding', 'crÃ¨me', 'tarte',
      
      // French restaurant terms
      'restaurant', 'cuisine', 'menu', 'prix', 'portion', 'service',
      'chef', 'cuisinier', 'serveur', 'rÃ©ceptionniste', 'rÃ©servation', 'table',
      
      // French adjectives and descriptions
      'dÃ©licieux', 'savoureux', 'frais', 'chaud', 'froid', 'Ã©picÃ©', 'doux',
      'salÃ©', 'acide', 'amer', 'aromatique', 'traditionnel', 'maison', 'naturel',
      'bio', 'vÃ©gÃ©tarien', 'vÃ©gan', 'sans gluten', 'diÃ©tÃ©tique',
      
      // French cooking methods
      'frit', 'cuit', 'bouilli', 'grillÃ©', 'cuit', 'marinÃ©', 'fumÃ©',
      'au four', 'Ã  la vapeur', 'braisÃ©', 'sautÃ©', 'poÃªlÃ©', 'Ã  la plancha'
    ],
    patterns: [
      /(?:le|la|les|et|ou|mais|avec|en|de|Ã |pour|par|est|sont|Ã©tait|Ã©taient)/g, // Common French words
      /(?:nourriture|boisson|dessert|apÃ©ritif|plat)/g, // French food categories
    ],
    confidence: 0.7
  }
};

// Language codes mapping
const LANGUAGE_CODES = {
  romanian: 'ro',
  english: 'en',
  spanish: 'es',
  french: 'fr'
};

// Language names mapping
const LANGUAGE_NAMES = {
  romanian: 'Romanian',
  english: 'English',
  spanish: 'Spanish',
  french: 'French'
};

/**
 * Detect the language based on restaurant data and menu items
 */
export function detectLanguage(context: LanguageContext): LanguageDetectionResult {
  const allText = [
    context.restaurantName,
    context.restaurantAddress || '',
    ...context.menuItems.map(item => `${item.name} ${item.description || ''}`),
    ...context.categories
  ].join(' ').toLowerCase();

  const scores: Record<string, { score: number; indicators: string[] }> = {};
  
  // Initialize scores
  Object.keys(LANGUAGE_PATTERNS).forEach(lang => {
    scores[lang] = { score: 0, indicators: [] };
  });

  // Score based on keywords
  Object.entries(LANGUAGE_PATTERNS).forEach(([language, config]) => {
    const foundKeywords = config.keywords.filter(keyword => 
      allText.includes(keyword.toLowerCase())
    );
    
    if (foundKeywords.length > 0) {
      scores[language].score += foundKeywords.length * 2;
      scores[language].indicators.push(`Found ${foundKeywords.length} keywords: ${foundKeywords.slice(0, 3).join(', ')}`);
    }
  });

  // Score based on patterns (diacritics, common words)
  Object.entries(LANGUAGE_PATTERNS).forEach(([language, config]) => {
    config.patterns.forEach(pattern => {
      const matches = allText.match(pattern);
      if (matches) {
        scores[language].score += matches.length;
        scores[language].indicators.push(`Pattern matches: ${matches.length} occurrences`);
      }
    });
  });

  // Special detection for Romanian (diacritics are very strong indicators)
  const romanianDiacritics = allText.match(/Äƒ|Ã¢|Ã®|È™|È›/g);
  if (romanianDiacritics) {
    scores.romanian.score += romanianDiacritics.length * 3;
    scores.romanian.indicators.push(`Strong Romanian indicators: ${romanianDiacritics.length} diacritics found`);
  }

  // Find the language with the highest score
  let detectedLanguage = 'english'; // default
  let highestScore = 0;
  let confidence = 0;

  Object.entries(scores).forEach(([language, data]) => {
    if (data.score > highestScore) {
      highestScore = data.score;
      detectedLanguage = language;
      confidence = Math.min(data.score / 10, 1); // Normalize confidence to 0-1
    }
  });

  // If no strong indicators found, default to English
  if (highestScore < 2) {
    detectedLanguage = 'english';
    confidence = 0.3;
  }

  return {
    detectedLanguage,
    confidence,
    indicators: scores[detectedLanguage]?.indicators || [],
    suggestedLanguage: detectedLanguage
  };
}

/**
 * Get language code for the detected language
 */
export function getLanguageCode(language: string): string {
  return LANGUAGE_CODES[language as keyof typeof LANGUAGE_CODES] || 'en';
}

/**
 * Get language name for the detected language
 */
export function getLanguageName(language: string): string {
  return LANGUAGE_NAMES[language as keyof typeof LANGUAGE_NAMES] || 'English';
}

/**
 * Test language detection with sample data
 */
export function testLanguageDetection(): void {
  console.log('ðŸ§ª Testing Language Detection...\n');

  const testCases = [
    {
      name: 'Romanian Restaurant',
      context: {
        restaurantName: 'Restaurant TradiÈ›ional RomÃ¢nesc',
        restaurantAddress: 'Strada MÃ¢nÄƒstirii, BucureÈ™ti',
        menuItems: [
          { name: 'Sarmale cu mÄƒmÄƒligÄƒ', description: 'Sarmale tradiÈ›ionale cu mÄƒmÄƒligÄƒ È™i smÃ¢ntÃ¢nÄƒ' },
          { name: 'CiorbÄƒ de burtÄƒ', description: 'CiorbÄƒ tradiÈ›ionalÄƒ romÃ¢neascÄƒ' },
          { name: 'PapanÄƒÈ™i cu smÃ¢ntÃ¢nÄƒ', description: 'Desert tradiÈ›ional romÃ¢nesc' }
        ],
        categories: ['MÃ¢ncÄƒruri principale', 'Deserturi', 'BÄƒuturi']
      }
    },
    {
      name: 'English Restaurant',
      context: {
        restaurantName: 'Traditional English Pub',
        restaurantAddress: 'High Street, London',
        menuItems: [
          { name: 'Fish and Chips', description: 'Traditional English fish and chips with mushy peas' },
          { name: 'Beef Wellington', description: 'Classic English beef wellington with red wine sauce' },
          { name: 'Apple Crumble', description: 'Traditional English dessert with custard' }
        ],
        categories: ['Main Courses', 'Desserts', 'Beverages']
      }
    },
    {
      name: 'Spanish Restaurant',
      context: {
        restaurantName: 'Restaurante EspaÃ±ol',
        restaurantAddress: 'Calle Mayor, Madrid',
        menuItems: [
          { name: 'Paella Valenciana', description: 'Paella tradicional con mariscos y pollo' },
          { name: 'Gazpacho', description: 'Sopa frÃ­a tradicional espaÃ±ola' },
          { name: 'Flan de Caramelo', description: 'Postre tradicional espaÃ±ol' }
        ],
        categories: ['Platos principales', 'Postres', 'Bebidas']
      }
    }
  ];

  testCases.forEach(testCase => {
    const result = detectLanguage(testCase.context);
    console.log(`ðŸ“‹ ${testCase.name}:`);
    console.log(`   Detected: ${getLanguageName(result.detectedLanguage)} (${result.detectedLanguage})`);
    console.log(`   Confidence: ${(result.confidence * 100).toFixed(1)}%`);
    console.log(`   Indicators: ${result.indicators.join(', ')}`);
    console.log('');
  });
}

/**
 * Generate descriptions in the detected language
 */
export function generateDescriptionInLanguage(
  itemName: string,
  language: string,
  category?: string
): string {
  const descriptions = {
    romanian: {
      starters: [
        'Aperitiv tradiÈ›ional romÃ¢nesc, perfect pentru Ã®nceputul mesei',
        'Delicios aperitiv cu ingrediente proaspete È™i aromate',
        'Aperitiv gustos, pregÄƒtit dupÄƒ reÈ›ete tradiÈ›ionale'
      ],
      main_courses: [
        'Fel principal tradiÈ›ional, gÄƒtit cu pasiune È™i ingrediente proaspete',
        'Delicios fel principal cu sos aromat È™i garniturÄƒ tradiÈ›ionalÄƒ',
        'Fel principal gustos, pregÄƒtit dupÄƒ reÈ›ete de familie'
      ],
      desserts: [
        'Desert tradiÈ›ional romÃ¢nesc, perfect pentru Ã®ncheierea mesei',
        'Desert delicios cu gust autentic romÃ¢nesc',
        'Desert gustos, pregÄƒtit cu ingrediente naturale'
      ],
      default: [
        'Delicios preparat tradiÈ›ional romÃ¢nesc',
        'Gustos preparat cu ingrediente proaspete',
        'Preparat autentic, gÄƒtit cu pasiune'
      ]
    },
    english: {
      starters: [
        'Traditional starter, perfect to begin your meal',
        'Delicious appetizer with fresh and aromatic ingredients',
        'Tasty starter prepared with traditional recipes'
      ],
      main_courses: [
        'Traditional main course, cooked with passion and fresh ingredients',
        'Delicious main course with aromatic sauce and traditional garnish',
        'Tasty main course prepared with family recipes'
      ],
      desserts: [
        'Traditional dessert, perfect to end your meal',
        'Delicious dessert with authentic taste',
        'Tasty dessert prepared with natural ingredients'
      ],
      default: [
        'Delicious traditional preparation',
        'Tasty dish with fresh ingredients',
        'Authentic preparation, cooked with passion'
      ]
    },
    spanish: {
      starters: [
        'Aperitivo tradicional espaÃ±ol, perfecto para comenzar la comida',
        'Delicioso aperitivo con ingredientes frescos y aromÃ¡ticos',
        'Sabroso aperitivo preparado con recetas tradicionales'
      ],
      main_courses: [
        'Plato principal tradicional, cocinado con pasiÃ³n e ingredientes frescos',
        'Delicioso plato principal con salsa aromÃ¡tica y guarniciÃ³n tradicional',
        'Sabroso plato principal preparado con recetas familiares'
      ],
      desserts: [
        'Postre tradicional espaÃ±ol, perfecto para terminar la comida',
        'Delicioso postre con sabor autÃ©ntico',
        'Sabroso postre preparado con ingredientes naturales'
      ],
      default: [
        'Deliciosa preparaciÃ³n tradicional',
        'Sabroso plato con ingredientes frescos',
        'PreparaciÃ³n autÃ©ntica, cocinada con pasiÃ³n'
      ]
    },
    french: {
      starters: [
        'ApÃ©ritif traditionnel franÃ§ais, parfait pour commencer le repas',
        'DÃ©licieux apÃ©ritif avec des ingrÃ©dients frais et aromatiques',
        'Savoureux apÃ©ritif prÃ©parÃ© avec des recettes traditionnelles'
      ],
      main_courses: [
        'Plat principal traditionnel, cuisinÃ© avec passion et ingrÃ©dients frais',
        'DÃ©licieux plat principal avec sauce aromatique et garniture traditionnelle',
        'Savoureux plat principal prÃ©parÃ© avec des recettes familiales'
      ],
      desserts: [
        'Dessert traditionnel franÃ§ais, parfait pour terminer le repas',
        'DÃ©licieux dessert au goÃ»t authentique',
        'Savoureux dessert prÃ©parÃ© avec des ingrÃ©dients naturels'
      ],
      default: [
        'DÃ©licieuse prÃ©paration traditionnelle',
        'Savoureux plat avec des ingrÃ©dients frais',
        'PrÃ©paration authentique, cuisinÃ©e avec passion'
      ]
    }
  };

  const langDescriptions = descriptions[language as keyof typeof descriptions] || descriptions.english;
  const categoryDescriptions = langDescriptions[category as keyof typeof langDescriptions] || langDescriptions.default;
  
  // Return a random description from the appropriate category
  const randomIndex = Math.floor(Math.random() * categoryDescriptions.length);
  return categoryDescriptions[randomIndex];
}

