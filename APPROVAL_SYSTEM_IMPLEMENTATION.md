# Table Approval System Implementation

## Status: In Progress

### âœ… Completed

1. **Database Schema** (`scripts/create-table-approval-system.sql`)
   - `table_approval_requests` table
   - `table_participants` table
   - `table_approval_audit` table
   - Indexes and cleanup function

2. **API Endpoints** (`src/app/api/table-orders/[tableId]/approval/route.ts`)
   - POST: Create approval request (auto-approves first scanner)
   - GET: Fetch pending approval requests (for existing participants)
   - PATCH: Approve/deny requests

3. **Session ID Fixes**
   - Session ID generated at table creation
   - Session ID ensured at QR generation
   - Redirect endpoint uses existing session_id (doesn't generate new one)
   - Session ID only regenerated by admin (refresh button) and when table is closed

4. **POST Endpoint Updates** (`src/app/api/table-orders/[tableId]/route.ts`)
   - Checks if user is a participant before allowing item addition
   - Returns approval required error if not a participant
   - Returns approval pending status if request exists

### ðŸš§ In Progress / TODO

1. **Client-Side Hook Updates** (`src/hooks/useTableCart.ts`)
   - [ ] Add approval request state management
   - [ ] Add function to request approval
   - [ ] Add polling for approval status
   - [ ] Add polling for pending requests (for existing participants)
   - [ ] Handle approval required errors from POST
   - [ ] Update participant status tracking

2. **UI Components**
   - [ ] Approval Request Modal (with 20-second timer)
   - [ ] Approval Notification Component (for existing participants)
   - [ ] Integration into menu page

3. **Audit Logging**
   - [x] Database table created
   - [x] API endpoints log to audit table
   - [ ] Admin view for audit logs (future)

### Implementation Notes

#### Flow:
1. First person scans QR â†’ Auto-approved as participant â†’ Can add items immediately
2. Second person scans QR â†’ Creates approval request â†’ Shows timer modal
3. First person sees notification â†’ Can approve/deny
4. If approved â†’ Second person becomes participant â†’ Can add items
5. If denied or expired â†’ Second person can retry

#### Security:
- Session ID validation still enforced
- Only participants can add items
- Only participants can approve requests
- All actions logged to audit table

#### Next Steps:
1. Complete `useTableCart` hook updates
2. Create UI components
3. Integrate into menu page
4. Test end-to-end flow

